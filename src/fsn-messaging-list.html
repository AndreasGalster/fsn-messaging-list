<dom-module id='fsn-messaging-list'>
  <template>
  <style include='houseme-styles'></style>
  <style>
  :host {
    display: block;
    height: calc(100vh - 64px);
    overflow-y: scroll;
    cursor: pointer;
  }

  img {
    left:10px;
    border-radius: 50%;
    width: 50px;
    height: 50px;
  }

  paper-icon-item {
    border-bottom: 1px solid rgba(0,0,0,0.3);
    /*border-bottom: 1px solid rgba(0,0,0,0.3);*/

    padding: 20px 10px;
    background: rgba(0,0,0,0.05);
  }

  paper-listbox {
    padding: 0;
  }

  </style>

  <!-- <template is='dom-if' if=[[userIsSelected(toUserId)]]>
    <paper-listbox>
      <paper-icon-item on-tap='removeMessageId' focused>
        <img class='avatar' item-icon src='http://graph.facebook.com/[[getUserImage(toUserId)]]/picture?type=square'>
        <paper-item-body>
          <div>[[getUserName(toUserId)]]</div>
        </paper-item-body>
      </paper-icon-item>
    </paper-listbox>
  </template> -->

  <template is="dom-if" if=[[subsReady]]>
    <template is='dom-if' if=[[messagesAvailable(messages)]]>
        <paper-listbox>
          <template is='dom-repeat' items=[[messages]] on-dom-change='getMessageId'>
              <paper-icon-item on-tap='getMessageId'>
                <img item-icon src='http://graph.facebook.com/[[getUserImage(item.toUserId)]]/picture?type=square'>
                <!-- <h5>[[item.messageId]]</h5> -->
                <!-- <div>[[item.toUserId]]</div> -->
                <!-- <div>[[item.messageId]]</div> -->
                <paper-item-body two-line>
                  <div>[[getUserName(item.toUserId)]]</div>
                </paper-item-body>
              </paper-icon-item>
            </template>
          </paper-listbox>
      <!-- <paper-button full-width on-transitionend='loadMoreMessages'>Load more conversations</paper-button> -->
    </template>
  </template>

    <template is='dom-if' if=[[!messagesAvailable(messages)]]>
      <h1>You don't have any messages yet. Why don't you check out some profiles to send your first message?</h1>
    </template>

  </template>
</dom-module>


<script>
  require('@polymer/polymer/polymer.html');

  require('@polymer/iron-list/iron-list.html');
  require('@polymer/iron-scroll-threshold/iron-scroll-threshold.html');


  require('@polymer/paper-button/paper-button.html');
  require('@polymer/paper-listbox/paper-listbox.html');
  require('@polymer/paper-item/paper-item.html');
  require('@polymer/paper-item/paper-icon-item.html');

  require('moment');

  require('@andreasgalster/fsn-boilerplate/dist/fsn-boilerplate.html');


  Polymer({
    is: 'fsn-messaging-list',
    behaviors:[mwcMixin],
    properties: {
      limiter: {
        type: Number,
        value: 8,
        observer: 'tracker'
      },
      messageId: {
        type: String,
        notify: true
      },
      toUserId: {
        type: String,
        value: '',
        notify: true
      }
    },
    attached: function() {
      // subscribes to users
      // retrieves facebook id and first_name
      this.subscribe('PrivateMessagesUsers');

      // subscribes to the list of message ids
      // does not contain facebook id or first_name
      this.subscribe('PrivateMessagesList');
    },

    // Shows or hides the currently selected user from the search
    userIsSelected: function(toUserId) {
      if(toUserId) {
        return true;
      }else {
        return false;
      }
    },

    getUserName: function(toUserId) {
      // console.log( `subsready is ${this._subsReady()}` );
      // console.log(Meteor.users.findOne({ _id: toUserId}).services.facebook.first_name);
      console.log(Meteor.users);
      // if(Meteor.users) {
        return Meteor.users.findOne({ _id: toUserId}).services.facebook.first_name;
      // }

      // this.autorun( () => {
        // return Meteor.users.findOne({ _id: toUserId}).services.facebook.first_name
      // });


    },
    getUserImage: function(toUserId) {
      console.log( `subsready is ${this._subsReady()}` );
      console.log(Meteor.users.find().fetch());
      console.log(toUserId);
      // console.log(Meteor.users.findOne({ _id: toUserId}).services.facebook.id);
      // if(this._subsReady()) {
      //   return Meteor.users.findOne({ _id: toUserId}).services.facebook.id;
      // }
      // if(Meteor.users) {
        return Meteor.users.findOne({ _id: toUserId}).services.facebook.id;
      // }
    },
    // retrieves the messageId. the ID gets fetched to the chat
    getMessageId: function(e) {
      if(e.type === 'dom-change') {
        if(!this.selected) {
          this.$$('paper-listbox').selected = 0;
          this.selected = true;
        }
        const firstItem = this.$$('paper-icon-item');
        this.messageId = e.target.modelForElement(firstItem).item.messageId;
      }
    },
    tracker: function() {
      this.messages = PrivateMessagesList.find().fetch(); //runs every time status changes.
    },
    messagesAvailable: function(messages){
      if(messages.length > 0) {
        return true;
      }
    },
    loadMoreMessages: function() {
      this.limiter = this.limiter + 8;
      // ironScrollTheshold.clearTriggers();
    }

  });

</script>
